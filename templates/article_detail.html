{% extends "base.html" %}

{% block title %}{{ article.title }} - Globe News{% endblock %}

{% block breadcrumb %}
<div class="container breadcrumb">
    <a href="{{ url_for('index') }}">Home</a> &gt;
    <a href="{{ url_for('category_detail', category_name=article.category_name) }}">{{ article.category_name }}</a> &gt;
    <span>{{ article.title|truncate(50) }}</span>
</div>
{% endblock %}

{% block content %}
<div class="article-detail-page">
    <!-- Alert Messages -->
    {% if error_message %}
    <div class="alert alert-danger">
        <i class="fas fa-exclamation-circle"></i> {{ error_message }}
    </div>
    {% endif %}
    
    <!-- Content Warning -->
    {% if content_warning %}
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle"></i> {{ content_warning }}
        <p class="mt-1" style="font-size: 0.9rem; opacity: 0.8;">
            <i class="fas fa-info-circle"></i> The preview may be limited. Full content extraction requires the article URL to be accessible.
        </p>
    </div>
    {% endif %}
    
    <!-- Preview Regeneration Banner -->
    {% if needs_regeneration %}
    <div class="regenerate-preview-banner alert alert-info">
        <div class="d-flex justify-between align-center">
            <div>
                <strong><i class="fas fa-sync-alt"></i> Preview Update Available</strong>
                <p class="mt-1 mb-0" style="font-size: 0.9rem;">
                    Regenerate to include full article content analysis.
                </p>
            </div>
            <a href="{{ url_for('regenerate_preview', article_id=article.id) }}" class="btn btn-primary">
                <i class="fas fa-magic"></i> Regenerate Preview
            </a>
        </div>
    </div>
    {% endif %}
    
    <!-- Article Header -->
    <div class="article-header">
        <div class="article-meta-top">
            <a href="{{ url_for('category_detail', category_name=article.category_name) }}" 
               class="article-category">
                <i class="fas fa-tag"></i> {{ article.category_name }}
            </a>
            <span class="article-badges">
                {% if article.is_breaking %}
                <span class="breaking-badge">
                    <i class="fas fa-bolt"></i> Breaking
                </span>
                {% endif %}
                
                <span class="language-badge">
                    {% if article.language == 'en' %}ðŸ‡¬ðŸ‡§ English{% else %}ðŸ‡·ðŸ‡¼ Kinyarwanda{% endif %}
                </span>
                
                {% if has_full_content %}
                <span class="content-extraction-badge">
                    <i class="fas fa-check-circle"></i> Full Content Analyzed
                </span>
                {% endif %}
            </span>
        </div>
        
        <h1 class="article-title">{{ article.title }}</h1>
        
        <div class="article-meta">
            <div class="article-source-info">
                {% set domain = article.url.replace('https://','').replace('http://','').split('/')[0] %}
                <img src="https://www.google.com/s2/favicons?domain={{ domain }}" 
                     alt="{{ article.source }}" 
                     class="source-favicon"
                     onerror="this.style.display='none'">
                <span class="article-source">{{ article.source }}</span>
                {% if article.author and article.author != 'Unknown' %}
                <span class="article-author">
                    <i class="fas fa-user-edit"></i> {{ article.author }}
                </span>
                {% endif %}
            </div>
            
            <div class="article-time-info">
                <span class="article-published">
                    <i class="far fa-clock"></i> {{ article.published_at|datetimeformat('%B %d, %Y %I:%M %p') }}
                </span>
                <span class="article-time-ago">({{ article.published_at|time_ago }})</span>
            </div>
        </div>
    </div>
    
    <!-- Article Image -->
    {% if article.url_to_image %}
    <div class="article-image-container">
        <img src="{{ article.url_to_image }}" 
             alt="{{ article.title }}" 
             class="article-main-image"
             onerror="this.src='https://images.unsplash.com/photo-1588681664899-f142ff2dc9b1?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80'">
        {% if article.source %}
        <div class="image-caption">Source: {{ article.source }}</div>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Content Sections -->
    <div class="article-content-sections">
        <!-- Article Description -->
        {% if article.description %}
        <section class="article-description-section">
            <h2 class="section-heading">
                <i class="fas fa-newspaper"></i> Article Summary
            </h2>
            <div class="article-description">
                {{ article.description|safe }}
            </div>
        </section>
        {% endif %}
        
        <!-- Content Preview -->
        <section class="preview-section">
            <div class="section-header">
                <h2 class="section-heading">
                    <i class="fas fa-analytics"></i> Content Analysis
                    {% if preview_html %}
                    <span class="section-subheading">Enhanced Preview</span>
                    {% endif %}
                </h2>
                
                <div class="preview-actions">
                    {% if preview_html %}
                    <a href="{{ url_for('regenerate_preview', article_id=article.id) }}" 
                       class="btn btn-outline btn-sm">
                        <i class="fas fa-redo"></i> Regenerate
                    </a>
                    {% endif %}
                    
                    <a href="{{ article.url }}" 
                       target="_blank" 
                       class="btn btn-primary btn-sm">
                        <i class="fas fa-external-link-alt"></i> View Original
                    </a>
                </div>
            </div>
            
            {% if preview_html %}
            <div class="preview-content">
                {{ preview_html|safe }}
            </div>
            {% else %}
            <div class="no-preview">
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-analytics"></i>
                    </div>
                    <h3>No Preview Available</h3>
                    <p>This article hasn't been analyzed yet. Generate a preview to see key insights and analysis.</p>
                    <a href="{{ url_for('regenerate_preview', article_id=article.id) }}" class="btn btn-primary">
                        <i class="fas fa-magic"></i> Generate Preview
                    </a>
                </div>
            </div>
            {% endif %}
        </section>
        
        <!-- Full Article Content (if available) -->
        {% if article.content and article.content|length > 100 %}
        <section class="full-content-section">
            <h2 class="section-heading">
                <i class="fas fa-align-left"></i> Full Article Content
                {% if content_length %}
                <span class="content-length">({{ content_length }} characters)</span>
                {% endif %}
            </h2>
            <div class="full-content">
                {{ article.content|safe }}
            </div>
        </section>
        {% endif %}
    </div>
    
    <!-- Article Actions -->
    <div class="article-actions">
        <div class="action-buttons">
            <a href="{{ article.url }}" target="_blank" class="btn btn-primary">
                <i class="fas fa-external-link-alt"></i> Read Original Article
            </a>
            
            <button class="btn btn-secondary" onclick="shareArticle()">
                <i class="fas fa-share-alt"></i> Share
            </button>
            
            <a href="{{ url_for('regenerate_preview', article_id=article.id) }}" class="btn btn-outline">
                <i class="fas fa-redo"></i> Refresh Analysis
            </a>
        </div>
        
        <div class="article-stats">
            <span class="stat">
                <i class="fas fa-database"></i> 
                {% if has_full_content %}Full Content{% else %}RSS Content{% endif %}
            </span>
            {% if content_length %}
            <span class="stat">
                <i class="fas fa-ruler"></i> {{ content_length }} chars
            </span>
            {% endif %}
            <span class="stat">
                <i class="fas fa-globe"></i> {{ article.language|upper }}
            </span>
        </div>
    </div>
    
    <!-- Related Articles -->
    {% if article.related_articles %}
    <section class="related-articles">
        <h2 class="section-heading">
            <i class="fas fa-layer-group"></i> Related Articles
        </h2>
        <div class="related-articles-grid">
            {% for related in article.related_articles[:4] %}
            <div class="related-article-card">
                {% if related.url_to_image %}
                <img src="{{ related.url_to_image }}" 
                     alt="{{ related.title }}" 
                     class="related-article-image"
                     onerror="this.style.display='none'">
                {% endif %}
                <div class="related-article-content">
                    <div class="related-article-category">
                        {{ related.category_name }}
                    </div>
                    <h3 class="related-article-title">
                        <a href="{{ url_for('article_detail', article_id=related.id) }}">
                            {{ related.title|truncate(80) }}
                        </a>
                    </h3>
                    <div class="related-article-meta">
                        <span class="related-article-source">{{ related.source }}</span>
                        <span class="related-article-time">{{ related.published_at|time_ago }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}
    
    <!-- Article Metadata -->
    <div class="article-metadata">
        <div class="metadata-section">
            <h3 class="metadata-heading">
                <i class="fas fa-info-circle"></i> Article Information
            </h3>
            <div class="metadata-grid">
                <div class="metadata-item">
                    <span class="metadata-label">Source</span>
                    <span class="metadata-value">{{ article.source }}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Category</span>
                    <span class="metadata-value">{{ article.category_name }}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Language</span>
                    <span class="metadata-value">
                        {% if article.language == 'en' %}English{% else %}Kinyarwanda{% endif %}
                    </span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Published</span>
                    <span class="metadata-value">{{ article.published_at|datetimeformat }}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Content Type</span>
                    <span class="metadata-value">
                        {% if has_full_content %}Full Article{% else %}RSS Summary{% endif %}
                    </span>
                </div>
                {% if article.author and article.author != 'Unknown' %}
                <div class="metadata-item">
                    <span class="metadata-label">Author</span>
                    <span class="metadata-value">{{ article.author }}</span>
                </div>
                {% endif %}
                <div class="metadata-item">
                    <span class="metadata-label">Article ID</span>
                    <span class="metadata-value">#{{ article.id }}</span>
                </div>
            </div>
        </div>
        
        <div class="metadata-section">
            <h3 class="metadata-heading">
                <i class="fas fa-link"></i> Quick Actions
            </h3>
            <div class="action-links">
                <a href="{{ url_for('category_detail', category_name=article.category_name) }}" 
                   class="action-link">
                    <i class="fas fa-folder"></i> More {{ article.category_name }} News
                </a>
                <a href="{{ url_for('index') }}?language={{ article.language }}" 
                   class="action-link">
                    <i class="fas fa-globe"></i> More 
                    {% if article.language == 'en' %}English{% else %}Kinyarwanda{% endif %} News
                </a>
                <a href="{{ url_for('search') }}?q={{ article.category_name }}" 
                   class="action-link">
                    <i class="fas fa-search"></i> Search {{ article.category_name }}
                </a>
                <button class="action-link" onclick="copyArticleLink()">
                    <i class="fas fa-copy"></i> Copy Article Link
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Share Article Function
    function shareArticle() {
        if (navigator.share) {
            navigator.share({
                title: '{{ article.title }}',
                text: 'Check out this article on Globe News',
                url: window.location.href
            })
            .then(() => console.log('Article shared successfully'))
            .catch(error => console.log('Error sharing:', error));
        } else {
            // Fallback: Copy to clipboard
            copyArticleLink();
        }
    }
    
    // Copy Article Link
    function copyArticleLink() {
        const url = window.location.href;
        navigator.clipboard.writeText(url)
            .then(() => {
                showToast('Article link copied to clipboard!');
            })
            .catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy link. Please copy manually.');
            });
    }
    
    // Show Toast Notification
    function showToast(message) {
        // Remove existing toast
        const existingToast = document.querySelector('.toast-notification');
        if (existingToast) existingToast.remove();
        
        // Create toast
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.innerHTML = `
            <div class="toast-content">
                <i class="fas fa-check-circle"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Show toast
        setTimeout(() => toast.classList.add('show'), 10);
        
        // Remove toast after 3 seconds
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    
    // Image Error Handling
    document.querySelectorAll('.article-main-image, .related-article-image').forEach(img => {
        img.addEventListener('error', function() {
            if (this.classList.contains('article-main-image')) {
                this.src = 'https://images.unsplash.com/photo-1588681664899-f142ff2dc9b1?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80';
            }
            this.onerror = null;
        });
    });
    
    // Preview Content Enhancement
    document.addEventListener('DOMContentLoaded', function() {
        // Add click handlers to preview links to open in new tab
        document.querySelectorAll('.preview-content a').forEach(link => {
            link.setAttribute('target', '_blank');
            link.setAttribute('rel', 'noopener noreferrer');
        });
        
        // Smooth scroll for anchor links within preview
        document.querySelectorAll('.preview-content a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('href');
                if (targetId !== '#') {
                    const targetElement = document.querySelector(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                }
            });
        });
        
        // Add loading state to regenerate button
        document.querySelectorAll('a[href*="regenerate"]').forEach(link => {
            link.addEventListener('click', function(e) {
                if (this.classList.contains('processing')) {
                    e.preventDefault();
                    return;
                }
                
                this.classList.add('processing');
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                this.style.pointerEvents = 'none';
                
                // Re-enable after 15 seconds if still on page
                setTimeout(() => {
                    if (this.classList.contains('processing')) {
                        this.classList.remove('processing');
                        this.innerHTML = originalText;
                        this.style.pointerEvents = 'auto';
                        showToast('Preview generation is taking longer than expected. Please wait...');
                    }
                }, 15000);
            });
        });
    });
    
    // Keyboard Shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + S to share
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            shareArticle();
        }
        
        // Ctrl/Cmd + C to copy link
        if ((e.ctrlKey || e.metaKey) && e.key === 'c' && e.shiftKey) {
            e.preventDefault();
            copyArticleLink();
        }
        
        // Escape to close any open modals/toasts
        if (e.key === 'Escape') {
            document.querySelectorAll('.toast-notification').forEach(toast => {
                toast.remove();
            });
        }
    });
    
    // Backend Health Check for Preview Generation
    async function checkBackendHealth() {
        try {
            const response = await fetch('/api/health');
            const data = await response.json();
            
            if (data.backend.status !== 'healthy') {
                const regenerateBtn = document.querySelector('a[href*="regenerate"]');
                if (regenerateBtn) {
                    regenerateBtn.style.opacity = '0.5';
                    regenerateBtn.style.pointerEvents = 'none';
                    regenerateBtn.title = 'Backend is offline. Cannot generate preview.';
                }
            }
        } catch (error) {
            console.warn('Backend health check failed:', error);
        }
    }
    
    // Check backend health on page load
    document.addEventListener('DOMContentLoaded', checkBackendHealth);
</script>
{% endblock %}