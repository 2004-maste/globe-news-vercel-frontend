{% extends "base.html" %}

{% block title %}{{ article.title }} - Globe News{% endblock %}

{% block meta_description %}
{%- if article.human_summary -%}
{{ article.human_summary|truncate(160) }}
{%- elif article.preview_content -%}
{{ article.preview_content|striptags|truncate(160) }}
{%- else -%}
{{ article.description|truncate(160) }}
{%- endif -%}
{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb-wrapper">
    <div class="container">
        <nav class="breadcrumb-nav" aria-label="breadcrumb">
            <a href="{{ url_for('index') }}" class="breadcrumb-link">
                <i class="fas fa-home"></i> Home
            </a>
            <span class="breadcrumb-separator">â€º</span>
            <a href="{{ url_for('category_detail', category_name=article.category_name) }}" 
               class="breadcrumb-link">
                {{ article.category_name }}
            </a>
            <span class="breadcrumb-separator">â€º</span>
            <span class="breadcrumb-current">{{ article.title|truncate(50) }}</span>
        </nav>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="article-detail-page">
    <!-- Alert Messages -->
    {% if error_message %}
    <div class="alert error-alert" role="alert">
        <div class="alert-icon">
            <i class="fas fa-exclamation-circle"></i>
        </div>
        <div class="alert-content">
            <p>{{ error_message }}</p>
        </div>
        <button class="alert-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    {% endif %}
    
    <!-- Content Warning -->
    {% if content_warning %}
    <div class="alert warning-alert" role="alert">
        <div class="alert-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="alert-content">
            <strong>{{ content_warning }}</strong>
            <p class="mt-2">The preview may be limited. Full content extraction requires the article URL to be accessible.</p>
        </div>
        <button class="alert-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    {% endif %}
    
    <!-- Article Header -->
    <div class="article-header-wrapper">
        <div class="article-meta-top">
            <a href="{{ url_for('category_detail', category_name=article.category_name) }}" 
               class="category-link">
                <span class="category-dot" style="background-color: {{ article.category_name|category_color }}"></span>
                <span>{{ article.category_name }}</span>
            </a>
            
            <div class="article-badges">
                {% if article.is_breaking %}
                <span class="badge badge-breaking">
                    <i class="fas fa-bolt"></i> Breaking
                </span>
                {% endif %}
                
                <span class="badge badge-language {% if article.language == 'en' %}badge-en{% else %}badge-rw{% endif %}">
                    {% if article.language == 'en' %}ðŸ‡¬ðŸ‡§ English{% else %}ðŸ‡·ðŸ‡¼ Kinyarwanda{% endif %}
                </span>
                
                {% if has_full_content %}
                <span class="badge badge-full-content">
                    <i class="fas fa-check-circle"></i> Full Analysis
                </span>
                {% endif %}

                <!-- Human Summary Badge -->
                {% if article.human_summary %}
                <span class="badge badge-human-summary" title="This article has an editor's summary">
                    <i class="fas fa-pen-fancy"></i> Editor's Pick
                </span>
                {% endif %}
                
                <!-- AI Preview Badge -->
                {% if not article.human_summary and (article.preview_content or preview_html) %}
                <span class="badge badge-ai-preview" title="AI-generated preview">
                    <i class="fas fa-robot"></i> AI Analysis
                </span>
                {% endif %}
            </div>
        </div>
        
        <h1 class="article-main-title">{{ article.title }}</h1>
        
        <div class="article-byline">
            <div class="byline-avatar">
                <div class="avatar-initials">
                    {{ article.source[:1]|upper }}
                </div>
            </div>
            <div class="byline-info">
                <div class="byline-name">
                    <span class="byline-source">{{ article.source }}</span>
                    {% if article.author and article.author != 'Unknown' %}
                    <span class="byline-author">by {{ article.author }}</span>
                    {% endif %}
                </div>
                <div class="byline-meta">
                    <span class="meta-item">
                        <i class="far fa-calendar-alt"></i> 
                        {{ article.published_at|datetimeformat('%B %d, %Y') }}
                    </span>
                    <span class="meta-item">
                        <i class="far fa-clock"></i> 
                        {{ article.published_at|datetimeformat('%I:%M %p') }}
                    </span>
                    <span class="meta-item meta-time-ago">
                        ({{ article.published_at|time_ago }})
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Article Hero Image -->
    {% if article.url_to_image %}
    <div class="article-hero">
        <div class="hero-image-container">
            <img src="{{ article.url_to_image }}" 
                 alt="{{ article.title }}" 
                 class="hero-image"
                 onerror="this.src='https://images.unsplash.com/photo-1588681664899-f142ff2dc9b1?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80'">
            <div class="hero-caption">
                <i class="fas fa-camera"></i> Source: {{ article.source }}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Main Content Grid -->
    <div class="content-grid">
        <!-- Main Content Column -->
        <div class="main-content-column">
            <!-- HUMAN SUMMARY SECTION - PRIORITY 1 -->
            {% if article.human_summary %}
            <div class="content-card human-summary-card">
                <div class="card-header">
                    <div class="header-icon">
                        <i class="fas fa-pen-fancy text-warning"></i>
                    </div>
                    <h2 class="header-title">Editor's Summary</h2>
                    <span class="header-badge">Human-Written</span>
                    
                    <div class="header-actions">
                        <span class="badge badge-editor" title="Reviewed by editorial team">
                            <i class="fas fa-check-circle"></i> Verified
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="human-summary-content">
                        <div class="summary-quote-mark"><i class="fas fa-quote-left"></i></div>
                        <p class="summary-text">{{ article.human_summary }}</p>
                        <div class="summary-footer">
                            <span class="summary-author">
                                <i class="fas fa-user-edit"></i> Globe News Editorial Team
                            </span>
                            <span class="summary-date">
                                <i class="far fa-calendar-check"></i> 
                                Updated: {{ article.approved_at|datetimeformat('%B %d, %Y') if article.approved_at else 'Recently' }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- AI PREVIEW SECTION - PRIORITY 2 (only shown if no human summary) -->
            {% if not article.human_summary and preview_html %}
            <div class="content-card preview-card">
                <div class="card-header">
                    <div class="header-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <h2 class="header-title">AI Content Analysis</h2>
                    <span class="header-badge">AI-Generated</span>
                    
                    <div class="header-actions">
                        <a href="{{ url_for('regenerate_preview', article_id=article.id) }}" 
                           class="btn-icon" title="Regenerate Preview">
                            <i class="fas fa-redo-alt"></i>
                        </a>
                        
                        <a href="{{ article.url }}" 
                           target="_blank" 
                           class="btn-icon" 
                           title="View Original">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="preview-content-wrapper">
                        <div class="preview-content">
                            {{ preview_html|safe }}
                        </div>
                        
                        <div class="preview-footer">
                            <span class="preview-note">
                                <i class="fas fa-robot"></i> AI-generated preview
                                {% if needs_regeneration %}
                                <span class="preview-warning">(may need refresh)</span>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Article Description (only if no other summaries) -->
            {% if not article.human_summary and not preview_html and article.description %}
            <div class="content-card description-card">
                <div class="card-header">
                    <div class="header-icon">
                        <i class="fas fa-newspaper"></i>
                    </div>
                    <h2 class="header-title">Article Summary</h2>
                    <span class="header-badge">RSS Feed</span>
                </div>
                <div class="card-body">
                    <div class="description-content">
                        {{ article.description|safe }}
                    </div>
                    {% if needs_regeneration %}
                    <div class="description-footer">
                        <a href="{{ url_for('regenerate_preview', article_id=article.id) }}" 
                           class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-robot"></i> Generate AI Preview
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <!-- Full Article Content -->
            {% if article.content and article.content|length > 100 %}
            <div class="content-card full-content-card">
                <div class="card-header">
                    <div class="header-icon">
                        <i class="fas fa-align-left"></i>
                    </div>
                    <h2 class="header-title">Full Article Content</h2>
                    {% if content_length %}
                    <span class="header-badge">{{ content_length }} chars</span>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="full-content">
                        {{ article.content|safe }}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Sidebar Column -->
        <div class="sidebar-column">
            <!-- Article Actions Card -->
            <div class="sidebar-card actions-card">
                <h3 class="sidebar-title">Actions</h3>
                <div class="action-grid">
                    <a href="{{ article.url }}" target="_blank" class="action-item primary-action">
                        <div class="action-icon">
                            <i class="fas fa-external-link-alt"></i>
                        </div>
                        <div class="action-info">
                            <span class="action-label">Read Original</span>
                            <span class="action-desc">View on source site</span>
                        </div>
                    </a>
                    
                    <button class="action-item" onclick="shareArticle()">
                        <div class="action-icon">
                            <i class="fas fa-share-alt"></i>
                        </div>
                        <div class="action-info">
                            <span class="action-label">Share</span>
                            <span class="action-desc">Share this article</span>
                        </div>
                    </button>
                    
                    <button class="action-item" onclick="copyArticleLink()">
                        <div class="action-icon">
                            <i class="fas fa-copy"></i>
                        </div>
                        <div class="action-info">
                            <span class="action-label">Copy Link</span>
                            <span class="action-desc">Copy to clipboard</span>
                        </div>
                    </button>
                    
                    {% if not article.human_summary %}
                    <a href="{{ url_for('regenerate_preview', article_id=article.id) }}" class="action-item regenerate-btn">
                        <div class="action-icon">
                            <i class="fas fa-sync-alt"></i>
                        </div>
                        <div class="action-info">
                            <span class="action-label">Refresh AI</span>
                            <span class="action-desc">Update analysis</span>
                        </div>
                    </a>
                    {% endif %}
                </div>
            </div>
            
            <!-- Article Stats Card -->
            <div class="sidebar-card stats-card">
                <h3 class="sidebar-title">Article Stats</h3>
                <div class="stats-list">
                    <div class="stat-item">
                        <span class="stat-label">Content Type</span>
                        <span class="stat-value">
                            {% if has_full_content %}Full Article{% else %}RSS Summary{% endif %}
                        </span>
                    </div>
                    
                    <!-- Summary Type Indicator -->
                    <div class="stat-item">
                        <span class="stat-label">Summary Type</span>
                        <span class="stat-value">
                            {% if article.human_summary %}
                            <span class="text-warning"><i class="fas fa-pen-fancy"></i> Human-Written</span>
                            {% elif article.preview_content or preview_html %}
                            <span class="text-info"><i class="fas fa-robot"></i> AI-Generated</span>
                            {% else %}
                            <span class="text-secondary"><i class="fas fa-rss"></i> RSS Only</span>
                            {% endif %}
                        </span>
                    </div>
                    
                    {% if content_length %}
                    <div class="stat-item">
                        <span class="stat-label">Length</span>
                        <span class="stat-value">{{ content_length }} chars</span>
                    </div>
                    {% endif %}
                    
                    <div class="stat-item">
                        <span class="stat-label">Language</span>
                        <span class="stat-value">{{ article.language|upper }}</span>
                    </div>
                    
                    <div class="stat-item">
                        <span class="stat-label">Category</span>
                        <span class="stat-value">{{ article.category_name }}</span>
                    </div>
                    
                    <div class="stat-item">
                        <span class="stat-label">Article ID</span>
                        <span class="stat-value">#{{ article.id }}</span>
                    </div>
                    
                    {% if article.approved_at %}
                    <div class="stat-item">
                        <span class="stat-label">Reviewed</span>
                        <span class="stat-value">{{ article.approved_at|datetimeformat('%b %d, %Y') }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- About Our Summaries Card -->
            <div class="sidebar-card info-card">
                <h3 class="sidebar-title">About Our Summaries</h3>
                <div class="info-content">
                    <p class="info-text">
                        <i class="fas fa-pen-fancy text-warning"></i> 
                        <strong>Human-Written:</strong> Curated by our editorial team for accuracy and insight.
                    </p>
                    <p class="info-text">
                        <i class="fas fa-robot text-info"></i> 
                        <strong>AI-Generated:</strong> Automated previews for quick understanding.
                    </p>
                    <p class="info-text">
                        <i class="fas fa-rss text-secondary"></i> 
                        <strong>RSS Only:</strong> Original feed summary, no additional analysis.
                    </p>
                    <p class="info-text mt-2 small text-muted">
                        Human summaries represent our editorial team's analysis and are updated regularly.
                    </p>
                </div>
            </div>
            
            <!-- Quick Links Card -->
            <div class="sidebar-card quicklinks-card">
                <h3 class="sidebar-title">Quick Links</h3>
                <div class="quicklinks-list">
                    <a href="{{ url_for('category_detail', category_name=article.category_name) }}" 
                       class="quicklink-item">
                        <i class="fas fa-folder-open"></i>
                        <span>More {{ article.category_name }} News</span>
                    </a>
                    
                    <a href="{{ url_for('index') }}?language={{ article.language }}" 
                       class="quicklink-item">
                        <i class="fas fa-globe"></i>
                        <span>More {% if article.language == 'en' %}English{% else %}Kinyarwanda{% endif %} News</span>
                    </a>
                    
                    <a href="{{ url_for('search') }}?q={{ article.category_name }}" 
                       class="quicklink-item">
                        <i class="fas fa-search"></i>
                        <span>Search {{ article.category_name }}</span>
                    </a>
                    
                    <a href="{{ article.url }}" target="_blank" class="quicklink-item">
                        <i class="fas fa-external-link-square-alt"></i>
                        <span>Visit Source</span>
                    </a>
                </div>
            </div>
            
            <!-- Source Info Card -->
            <div class="sidebar-card source-card">
                <h3 class="sidebar-title">Source Information</h3>
                <div class="source-details">
                    {% set domain = article.url.replace('https://','').replace('http://','').split('/')[0] %}
                    <div class="source-favicon-container">
                        <img src="https://www.google.com/s2/favicons?domain={{ domain }}" 
                             alt="{{ article.source }}" 
                             class="source-favicon"
                             onerror="this.style.display='none'">
                        <span class="source-name">{{ article.source }}</span>
                    </div>
                    {% if article.author and article.author != 'Unknown' %}
                    <div class="source-author">
                        <i class="fas fa-user-edit"></i> {{ article.author }}
                    </div>
                    {% endif %}
                    <div class="source-published">
                        <i class="far fa-calendar-check"></i> {{ article.published_at|datetimeformat }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Related Articles Section -->
    {% if article.related_articles %}
    <section class="related-section">
        <div class="section-header-wrapper">
            <h2 class="section-title">
                <i class="fas fa-layer-group"></i> Related Articles
            </h2>
            <p class="section-subtitle">More stories you might be interested in</p>
        </div>
        
        <div class="related-grid">
            {% for related in article.related_articles[:4] %}
            <a href="{{ url_for('article_detail', article_id=related.id) }}" class="related-card">
                <div class="related-image-container">
                    {% if related.url_to_image %}
                    <img src="{{ related.url_to_image }}" 
                         alt="{{ related.title }}" 
                         class="related-image"
                         onerror="this.style.display='none'">
                    <div class="related-image-fallback" style="display: none;">
                        <i class="fas fa-newspaper"></i>
                    </div>
                    {% else %}
                    <div class="related-image-fallback">
                        <i class="fas fa-newspaper"></i>
                    </div>
                    {% endif %}
                    
                    <!-- Show if related article has human summary -->
                    {% if related.human_summary %}
                    <div class="related-badge" title="Has editor's summary">
                        <i class="fas fa-pen-fancy"></i>
                    </div>
                    {% elif related.preview_content %}
                    <div class="related-badge ai-badge" title="Has AI preview">
                        <i class="fas fa-robot"></i>
                    </div>
                    {% endif %}
                </div>
                
                <div class="related-content">
                    <div class="related-category">
                        <span class="category-dot-small" 
                              style="background-color: {{ related.category_name|category_color }}"></span>
                        {{ related.category_name }}
                    </div>
                    <h3 class="related-title">{{ related.title|truncate(80) }}</h3>
                    <div class="related-meta">
                        <span class="related-source">
                            <i class="fas fa-building"></i> {{ related.source }}
                        </span>
                        <span class="related-time">
                            <i class="far fa-clock"></i> {{ related.published_at|time_ago }}
                        </span>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </section>
    {% endif %}
    
    <!-- Article Footer -->
    <div class="article-footer">
        <div class="footer-content">
            <span class="footer-copyright">
                Â© 2026 Globe News | Powered by Master V Labs, Kigali
            </span>
            <div class="footer-actions">
                <button class="footer-btn" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
                    <i class="fas fa-arrow-up"></i> Back to Top
                </button>
            </div>
        </div>
    </div>
</div>

<!-- FIXED: Schema.org markup for rich results with human summary -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "NewsArticle",
    "headline": "{{ article.title }}",
    "image": "{{ article.url_to_image or 'https://globe-news-jade.vercel.app/static/images/default-news.jpg' }}",
    "datePublished": "{{ article.published_at }}",
    "dateModified": "{{ article.approved_at or article.published_at }}",
    "author": [{
        "@type": "Organization",
        "name": "{{ article.source }}",
        "url": "{{ article.url.split('/')[0:3]|join('/') }}"
    }],
    "publisher": {
        "@type": "Organization",
        "name": "Globe News",
        "logo": {
            "@type": "ImageObject",
            "url": "https://globe-news-jade.vercel.app/static/images/logo.png"
        }
    },
    "description": "{% if article.human_summary %}{{ article.human_summary|escape }}{% elif article.preview_content %}{{ article.preview_content|striptags|escape }}{% else %}{{ article.description|escape }}{% endif %}",
    "mainEntityOfPage": "{{ request.url }}",
    "keywords": "{{ article.category_name }}, {{ article.source }}, news"
}
</script>
{% endblock %}

{% block scripts %}
<script>
    // Toast Notification System
    class ToastManager {
        constructor() {
            this.container = document.createElement('div');
            this.container.className = 'toast-container';
            document.body.appendChild(this.container);
        }
        
        show(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                </div>
                <div class="toast-message">${message}</div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            this.container.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Auto remove
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    }
    
    // Initialize toast manager
    const toast = new ToastManager();
    
    // Share Article Function
    async function shareArticle() {
        try {
            const shareData = {
                title: '{{ article.title|escape }}',
                text: '{% if article.human_summary %}{{ article.human_summary|escape }}{% else %}Check out this article on Globe News{% endif %}',
                url: window.location.href
            };
            
            if (navigator.share) {
                await navigator.share(shareData);
                toast.show('Article shared successfully!');
            } else {
                // Fallback: Copy to clipboard
                await copyArticleLink();
                toast.show('Link copied! You can now share it manually.');
            }
        } catch (error) {
            if (error.name !== 'AbortError') {
                console.error('Error sharing:', error);
                toast.show('Failed to share article', 'error');
            }
        }
    }
    
    // Copy Article Link
    async function copyArticleLink() {
        try {
            await navigator.clipboard.writeText(window.location.href);
            toast.show('Article link copied to clipboard!');
        } catch (err) {
            console.error('Failed to copy: ', err);
            // Fallback
            const textarea = document.createElement('textarea');
            textarea.value = window.location.href;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            toast.show('Link copied to clipboard!');
        }
    }
    
    // Image Error Handling
    document.addEventListener('DOMContentLoaded', function() {
        // Handle hero image errors
        const heroImage = document.querySelector('.hero-image');
        if (heroImage) {
            heroImage.addEventListener('error', function() {
                this.src = 'https://images.unsplash.com/photo-1588681664899-f142ff2dc9b1?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80';
                this.onerror = null;
            });
        }
        
        // Handle related images errors
        document.querySelectorAll('.related-image').forEach(img => {
            img.addEventListener('error', function() {
                this.style.display = 'none';
                const fallback = this.closest('.related-image-container').querySelector('.related-image-fallback');
                if (fallback) {
                    fallback.style.display = 'flex';
                }
            });
        });
        
        // Enhance preview content links (if preview exists)
        document.querySelectorAll('.preview-content a').forEach(link => {
            link.setAttribute('target', '_blank');
            link.setAttribute('rel', 'noopener noreferrer nofollow');
        });
        
        // Add loading state to regenerate buttons
        document.querySelectorAll('.regenerate-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                if (this.classList.contains('loading')) {
                    e.preventDefault();
                    return;
                }
                
                this.classList.add('loading');
                const originalHtml = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                this.disabled = true;
                
                // Reset after timeout (in case page doesn't redirect)
                setTimeout(() => {
                    if (this.classList.contains('loading')) {
                        this.classList.remove('loading');
                        this.innerHTML = originalHtml;
                        this.disabled = false;
                        toast.show('Taking longer than expected. Please try again.', 'error');
                    }
                }, 15000);
            });
        });
        
        // Initialize tooltips
        document.querySelectorAll('[title]').forEach(el => {
            el.addEventListener('mouseenter', function(e) {
                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                tooltip.textContent = this.getAttribute('title');
                tooltip.style.top = e.pageY + 10 + 'px';
                tooltip.style.left = e.pageX + 10 + 'px';
                document.body.appendChild(tooltip);
                
                setTimeout(() => tooltip.classList.add('show'), 10);
                
                this.addEventListener('mouseleave', function() {
                    tooltip.remove();
                }, { once: true });
            });
        });

        // Highlight human summary if present
        const humanSummary = document.querySelector('.human-summary-card');
        if (humanSummary) {
            humanSummary.classList.add('highlight-card');
            // Add subtle animation
            setTimeout(() => {
                humanSummary.classList.add('fade-in');
            }, 100);
        }
    });
    
    // Keyboard Shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + S to share
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            shareArticle();
        }
        
        // Ctrl/Cmd + Shift + C to copy link
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'C') {
            e.preventDefault();
            copyArticleLink();
        }
        
        // Escape to close toasts
        if (e.key === 'Escape') {
            document.querySelectorAll('.toast').forEach(toast => {
                toast.remove();
            });
        }
        
        // ? to show help
        if (e.key === '?' && !e.ctrlKey && !e.metaKey) {
            e.preventDefault();
            toast.show('Keyboard Shortcuts: S (Share), Ctrl+Shift+C (Copy Link)', 'info');
        }
    });
    
    // Reading Progress Indicator
    function updateReadingProgress() {
        const winScroll = document.documentElement.scrollTop;
        const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        const scrolled = (winScroll / height) * 100;
        
        let progressBar = document.getElementById('reading-progress');
        if (!progressBar) {
            progressBar = document.createElement('div');
            progressBar.id = 'reading-progress';
            document.body.appendChild(progressBar);
        }
        progressBar.style.width = scrolled + '%';
    }
    
    window.addEventListener('scroll', updateReadingProgress);
</script>

<!-- Additional CSS for human summary styling -->
<style>
    .human-summary-card {
        border-left: 4px solid #fbbf24;
        background: linear-gradient(to right, rgba(251, 191, 36, 0.05), transparent);
        margin-bottom: 2rem;
    }
    
    .human-summary-content {
        position: relative;
        padding: 1rem 1.5rem;
    }
    
    .summary-quote-mark {
        position: absolute;
        top: 0;
        left: 0;
        font-size: 2rem;
        color: #fbbf24;
        opacity: 0.3;
    }
    
    .summary-text {
        font-size: 1.25rem;
        line-height: 1.8;
        font-style: italic;
        color: #e5e7eb;
        margin-bottom: 1rem;
        padding-left: 1.5rem;
    }
    
    .summary-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 0.75rem;
        border-top: 1px solid #374151;
        font-size: 0.875rem;
        color: #9ca3af;
    }
    
    .summary-author i, .summary-date i {
        margin-right: 0.25rem;
    }
    
    .badge-human-summary {
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
        color: #111827;
        border: none;
        padding: 0.35rem 0.75rem;
    }
    
    .badge-ai-preview {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
    }
    
    .badge-editor {
        background-color: #10b981;
        color: white;
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
    }
    
    .highlight-card {
        animation: cardGlow 2s ease-in-out;
    }
    
    @keyframes cardGlow {
        0% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.5); }
        50% { box-shadow: 0 0 20px 0 rgba(251, 191, 36, 0.3); }
        100% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0); }
    }
    
    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .related-badge {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: #fbbf24;
        color: #111827;
        width: 1.5rem;
        height: 1.5rem;
        border-radius: 9999px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        z-index: 2;
    }
    
    .related-badge.ai-badge {
        background: #3b82f6;
        color: white;
    }
    
    .text-warning {
        color: #fbbf24 !important;
    }
    
    .text-info {
        color: #3b82f6 !important;
    }
    
    .info-card {
        background: #1f2937;
        border-radius: 0.75rem;
    }
    
    .info-text {
        margin-bottom: 0.75rem;
        line-height: 1.6;
        font-size: 0.9rem;
        color: #d1d5db;
    }
    
    .info-text i {
        width: 1.25rem;
    }
    
    .preview-warning {
        color: #f59e0b;
        font-size: 0.8rem;
        margin-left: 0.5rem;
    }
    
    .description-footer {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #374151;
        text-align: center;
    }
    
    /* Loading state for regenerate button */
    .regenerate-btn.loading {
        opacity: 0.7;
        cursor: wait;
        pointer-events: none;
    }
    
    .regenerate-btn.loading .action-icon i {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}
